<div class="about-box">
    <div class="contact_form ruleList">
        <p class="adawdwadawd">配置单</p>
        <div class="row btnBox">
            <div class="col-sm-offset-4 col-sm-2 col-xs-offset-2 col-xs-4">
                <button type="button" class="addRule">添加配置</button>
            </div>
            <div class="col-sm-2 col-xs-4">
                <button type="button" class="upRule">开始预测</button>
            </div>
        </div>
    </div>
    <div class="contact_form row cost">
        <p class="adawdwadawd">成本预测</p>
        <div class="col-md-offset-1 col-md-10">
            <table class="table table-bordered costList"></table>
        </div>
    </div>
    <div class="contact_form row detailBtnBox">
        <div class="col-sm-offset-2 col-sm-4">
            <input type="tel" class="form-control tel" placeholder="手机号">
        </div>
        <div class="col-sm-2">
            <input type="text" class="form-control code" placeholder="验证码">
        </div>
        <div class="col-sm-2">
            <button type="button" class="detailBtn">获取收益预测</button>
        </div>
    </div>
    <div class="contact_form row detailCost">
        <p class="adawdwadawd">收益预测</p>
        <div class="col-md-offset-1 col-md-10">
            <table class="table table-bordered detailCostList" style="text-align: center;line-height: 100%">
                <tr>
                    <td colspan="13"><strong>360kw电桩</strong></td>
                </tr>
                <tr>
                    <td colspan="2">变压器:</td>
                    <td colspan="3">400kw</td>
                    <td colspan="2">终端数量:</td>
                    <td colspan="2">6</td>
                    <td colspan="2">投建功率</td>
                    <td colspan="2">360kw</td>
                </tr>
                <tr>
                    <td colspan="2">投资额:</td>
                    <td colspan="2">280000</td>
                    <td colspan="2">功率利用率:</td>
                    <td colspan="2">25%</td>
                    <td colspan="3" style="color: red">电损率:</td>
                    <td colspan="2" style="color: red">7%</td>
                </tr>
                <tr>
                    <td colspan="2">三费:</td>
                    <td colspan="2">15%</td>
                    <td colspan="2">场地费:</td>
                    <td colspan="2">20%</td>
                    <td colspan="3">保险费:</td>
                    <td colspan="2">350 /桩*年</td>
                </tr>
                <tr>
                    <td rowspan="2">类别</td>
                    <td rowspan="2">项目</td>
                    <td rowspan="2">单位</td>
                    <td rowspan="2">合计</td>
                    <td>建设期(年)</td>
                    <td colspan="8">经营期(年)</td>
                </tr>
                <tr>
                    <td>0</td>
                    <td>1</td>
                    <td>2</td>
                    <td>3</td>
                    <td>4</td>
                    <td>5</td>
                    <td>6</td>
                    <td>7</td>
                    <td>8</td>
                </tr>
                <tr>
                    <td rowspan="2">项目投资额</td>
                    <td>设备购置</td>
                    <td>元</td>
                    <td>280000</td>
                    <td>280000</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>固定资产年度折旧额</td>
                    <td>元</td>
                    <td>280000</td>
                    <td></td>
                    <td>35000</td>
                    <td>35000</td>
                    <td>35000</td>
                    <td>35000</td>
                    <td>35000</td>
                    <td>35000</td>
                    <td>35000</td>
                    <td>35000</td>
                </tr>
                <tr>
                    <td rowspan="2">经营资金流入</td>
                    <td>充电服务费收益</td>
                    <td>元</td>
                    <td>8888888</td>
                    <td></td>
                    <td>1111111</td>
                    <td>1111111</td>
                    <td>1111111</td>
                    <td>1111111</td>
                    <td>1111111</td>
                    <td>1111111</td>
                    <td>1111111</td>
                    <td>1111111</td>
                </tr>
                <tr>
                    <td>财政补贴收益</td>
                    <td>元</td>
                    <td>64000</td>
                    <td>64000</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td rowspan="4">经营资金流出</td>
                    <td>电损</td>
                    <td>元</td>
                    <td>88</td>
                    <td></td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                </tr>
                <tr>
                    <td>场地分成</td>
                    <td>元</td>
                    <td>88</td>
                    <td></td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                </tr>
                <tr>
                    <td>保险费</td>
                    <td>元</td>
                    <td>88</td>
                    <td></td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                </tr>
                <tr>
                    <td>三费(平台 代运营 运维)</td>
                    <td>元</td>
                    <td>88</td>
                    <td></td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                </tr>
                <tr>
                    <td>资金流净值</td>
                    <td>年度净资金流量</td>
                    <td>元</td>
                    <td>88</td>
                    <td></td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                </tr>
                <tr>
                    <td>净利润</td>
                    <td>年度净利润总额</td>
                    <td>元</td>
                    <td>88</td>
                    <td>nnnn</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                    <td>11</td>
                </tr>
            </table>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        var piles = JSON.parse('<?=\vendor\en\EnProductBase::getPiles()?>');
        var powerHtml = '';
        $.each(piles, function (k, v) {
            powerHtml += '<option value="' + k + '">' + v.name + '</option>';
        });
        addRule();
        $('.selectPicker').selectpicker('refresh');
        $('.about-box').on('change', '.power', function () {
            if ($(this).val()) {
                var numHtml = '<option value="0">枪口数</option>';
                $.each(piles[$(this).val()].para.split('-'), function (k, v) {
                    numHtml += '<option value="' + v + '">' + v + '</option>';
                });
                $(this).parents('.rule').find('.num').find('option').remove();
                $(this).parents('.rule').find('.num').append(numHtml);
                $(this).parents('.rule').find('.resultPower').text('单枪功率');
                $('.selectPicker').selectpicker('refresh');
            }
        });
        $('.about-box').on('change', '.num', function () {
            var power = $(this).parents('.rule').find('.power').val();
            if (power && $(this).val() !== '0') {
                $(this).parents('.rule').find('.resultPower').text(piles[power].power / $(this).val() + 'kw');
            }
            if ($(this).val() === '0') {
                $(this).parents('.rule').find('.resultPower').text('单枪功率');
            }
        });
        $('.about-box').on('click', '.delRule', function () {
            $(this).parents('.rule').remove();
        });
        $('.addRule').click(function () {
            addRule();
        });
        $('.upRule').click(function () {
            var data = [];
            $('.about-box').find('.rule').each(function (k, v) {
                var pile = $(this).find('.power').val();
                var num = $(this).find('.num').val();
                if (pile !== '0' && num !== '0') {
                    data[k] = {id: pile, num: num};
                }
            });
            if (data.length) {
                $.getJSON('/budget/budget/base-budget', {data: JSON.stringify(data)}, function (re) {
                    if (re.type) {
                        var str = '<tr>\n' +
                            '                    <td>电桩</td>\n' +
                            '                    <td>电桩功率(kw)</td>\n' +
                            '                    <td>枪口数量(个)</td>\n' +
                            '                    <td>枪口功率(kw)</td>\n' +
                            '                    <td>电桩价格(元)</td>\n' +
                            '                </tr>';
                        $.each(re.data.piles, function (k, v) {
                            str += '<tr>\n' +
                                '       <td>' + v.name + '</td>\n' +
                                '       <td>' + v.power + '</td>\n' +
                                '       <td>' + v.num + '</td>\n' +
                                '       <td>' + v.gunPower + '</td>\n' +
                                '       <td>' + v.price + '</td>\n' +
                                '   </tr>';
                        });
                        str += '<tr>\n' +
                            '       <td colspan="1">总功率</td>\n' +
                            '       <td colspan="4">' + re.data.totalPower + 'kw</td>\n' +
                            '   </tr>';
                        str += '<tr>\n' +
                            '       <td colspan="1">变压器</td>\n' +
                            '       <td colspan="2">' + re.data.transformer.name + '</td>\n' +
                            '       <td colspan="1">变压器价格</td>\n' +
                            '       <td colspan="1">' + re.data.transformer.price + '</td>\n' +
                            '   </tr>';
                        str += '<tr>\n' +
                            '       <td colspan="1">预计成本</td>\n' +
                            '       <td colspan="4">' + re.data.totalPrice + '元</td>\n' +
                            '   </tr>';
                        $('.costList').html(str);
                        $('.cost').fadeIn();
                        $('.detailBtnBox').fadeIn();
                    } else {
                        layer.msg('拉取预测信息失败');
                    }
                });
            } else {
                layer.msg('请填写配置单');
            }
        });

        function addRule() {
            var num = $('.about-box').find('.rule').length + 1;
            $('.btnBox').before('<div class="row rule">\n' +
                '            <div class="col-sm-offset-2 col-sm-1 ruleNum">配置 ' + num + '</div>\n' +
                '            <div class="col-sm-2">\n' +
                '                <select class="selectPicker form-control power" data-style="btn-white">\n' +
                '                    <option value="0">电桩型号</option>\n' + powerHtml +
                '                </select>\n' +
                '            </div>\n' +
                '            <div class="col-sm-2">\n' +
                '                <select class="selectPicker form-control num" data-style="btn-white">\n' +
                '                    <option value="0">枪口数</option>\n' +
                '                </select>\n' +
                '            </div>\n' +
                '            <div class="col-sm-2">\n' +
                '                <div class="form-control resultPower">单枪功率</div>\n' +
                '            </div>\n' +
                '            <div class="col-sm-1">\n' +
                '                <div class="delRule">删除</div>\n' +
                '            </div>\n' +
                '        </div>');
            $('.selectPicker').selectpicker('refresh');
        }
    });
</script>
